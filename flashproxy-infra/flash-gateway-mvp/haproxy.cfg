global
    log stdout format raw local0
    nbthread auto
    maxconn 200000

defaults
    mode tcp
    timeout client  4m
    timeout server  4m
    option  dontlognull

########################################
# Authentication table (MVP demo user)
########################################
userlist customers
    user demo insecure-password password plan 1gbps
    # → add real users here or manage via Runtime API

########################################
# Front-end – accepts HTTP CONNECT, HTTPS
#            and SOCKS5 (3proxy shim)
########################################
frontend edge_in
    bind :443                               # HTTPS / CONNECT
    bind :1080                              # SOCKS5 (handled by 3proxy)
    mode tcp

    # Basic-auth for CONNECT requests
    tcp-request inspect-delay 5s
    acl good_auth http_auth(customers)
    http-request auth realm FlashProxy if !good_auth

    # Per-user bandwidth cap (1 Gbps = 125 MB/s)
    stick-table type string size 1m expire 1s store bytes_out_rate(1s)
    tcp-request content track-sc0 user_auth()
    acl over_quota sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    default_backend superproxy

########################################
# Back-end – Bright Data super-proxy
########################################
backend superproxy
    mode tcp
    # user:pass@host:port — BrightData expects creds in the connect string
    server brd1 \
      brd-customer-hl_19cb0fe8-zone-al4-country-US-session-12345678:035knx33dmn2@brd.superproxy.io:22225
