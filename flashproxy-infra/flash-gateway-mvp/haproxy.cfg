###############################################################################
# FlashProxy – Edge Gateway (HAProxy 2.9)
#   auth handled by flash-auth-proxy (:443 -> 127.0.0.1:8443)
###############################################################################

############################### GLOBAL ########################################
global
    log stdout format raw local0
    master-worker
    nbthread 2
    maxconn 200000

############################### DEFAULTS ######################################
defaults
    mode            tcp                 # ← tunnel stays binary-clean
    timeout connect 5s
    timeout client  4m
    timeout server  4m
    option          dontlognull

############################### FRONTEND ######################################
frontend edge_in
    bind 127.0.0.1:8443

    # optional 1 Gb/s hard cap (remove if auth-proxy already enforces it)
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request session track-sc0 src
    acl over_quota  sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    # inject Bright Data credentials into the very first HTTP line only
    #   user : brd-customer-hl_19cb0fe8-zone-al4-country-US-session-12345678
    #   pass : 035knx33dmn2
    #   base64 = YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI=
    tcp-request content replace-value ^Proxy-Authorization:\ .* \
        "Proxy-Authorization: Basic YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI=" if { req.payload(0,256) -m found "CONNECT" }

    default_backend superproxy

############################### BACKEND #######################################
backend superproxy
    mode tcp
    server brd1 brd.superproxy.io:22225
