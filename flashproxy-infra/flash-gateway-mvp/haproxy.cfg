###############################################################################
# FlashProxy – Edge Gateway  (auth done upstream by flash-auth-proxy)
###############################################################################

global
    log stdout format raw local0
    master-worker
    nbthread 2
    maxconn 200000

defaults
    mode            http        # CONNECT is HTTP
    timeout connect 5s
    timeout client  4m
    timeout server  4m
    option          dontlognull

frontend edge_in
    bind 127.0.0.1:8443
    mode http

    # optional per-IP 1 Gb/s hard cap
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request session track-sc0 src
    acl  over_quota  sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    default_backend superproxy

backend superproxy
    mode http

    # user:pass@host:port  → HAProxy auto-adds      Proxy-Authorization: Basic …
    server brd1 \
        brd-customer-hl_19cb0fe8-zone-al4-country-US-session-12345678:035knx33dmn2@brd.superproxy.io:22225

    # strip Bright Data trace headers
    http-response del-header X-Luminati-IP
    http-response del-header X-Luminati-Timeline
    http-response del-header X-Luminati-Tun-Timeline
    http-response del-header X-Luminati-P2P-Timeline
    http-response del-header X-BRD-IP
    http-response del-header X-BRD-Timeline
    http-response del-header X-BRD-Tun-Timeline
    http-response del-header X-BRD-P2P-Timeline
