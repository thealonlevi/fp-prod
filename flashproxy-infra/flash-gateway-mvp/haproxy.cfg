###############################################################################
# Global settings
###############################################################################
global
    log stdout format raw local0
    nbthread 2
    maxconn 200000

###############################################################################
# Default settings
###############################################################################
defaults
    mode http
    timeout connect  5s
    timeout client   4m
    timeout server   4m
    option          dontlognull

###############################################################################
# User database  – proxy clients must authenticate here
###############################################################################
userlist clients
    user john12 insecure-password password1234
    user john   insecure-password password123
    # → for production use hashes:  openssl passwd -6 <pass>  →  user … password <hash>

###############################################################################
# Front-end  :443  – HTTPS CONNECT gateway
###############################################################################
frontend edge_in
    bind :443
    mode http

    # ── per-IP bandwidth cap (1 Gb/s) ────────────────────────────────────────
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request session track-sc0 src
    acl  over_quota sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    # ── accept Proxy-Authorization header & copy to Authorization ───────────
    http-request set-header Authorization %[req.hdr(Proxy-Authorization)] \
        if { req.hdr(Proxy-Authorization) -m found }

    # ── require Basic-Auth against userlist ─────────────────────────────────
    acl  good_auth http_auth(clients)
    http-request auth realm FlashProxy if !good_auth

    # ── inject Bright Data credentials ─────────────────────────────────────
    http-request set-header Proxy-Authorization \
        "Basic YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI="

    default_backend superproxy

###############################################################################
# Back-end  – Bright Data super-proxy
###############################################################################
backend superproxy
    mode http
    server brd1 brd.superproxy.io:22225

    # ── scrub Bright Data trace headers before they reach clients ───────────
    http-response del-header X-Luminati-IP
    http-response del-header X-Luminati-Timeline
    http-response del-header X-Luminati-Tun-Timeline
    http-response del-header X-Luminati-P2P-Timeline
    http-response del-header X-BRD-IP
    http-response del-header X-BRD-Timeline
    http-response del-header X-BRD-Tun-Timeline
    http-response del-header X-BRD-P2P-Timeline
