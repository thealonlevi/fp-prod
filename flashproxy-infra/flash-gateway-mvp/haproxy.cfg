###############################################################################
# FlashProxy – Edge Gateway (HAProxy 2.9)      auth is done upstream
###############################################################################

############################### GLOBAL ########################################
global
    log stdout format raw local0
    master-worker
    nbthread 2
    maxconn 200000

############################### DEFAULTS ######################################
defaults
    mode            http          # CONNECT is an HTTP request
    timeout connect 5s
    timeout client  4m
    timeout server  4m
    option          dontlognull

############################### FRONTEND ######################################
frontend edge_in
    bind 127.0.0.1:8443           # traffic comes from auth-proxy
    mode http

    # ── optional per-IP bandwidth cap (1 Gb/s) ──────────────────────────────
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request session track-sc0 src
    acl  over_quota  sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    # ── ensure Bright Data credentials are the ONLY header sent ────────────
    http-request del-header  Proxy-Authorization
    http-request add-header  Proxy-Authorization "Basic YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI="

    default_backend superproxy

############################### BACKEND #######################################
backend superproxy
    mode http
    server brd1 brd.superproxy.io:22225   # change to :443 ssl verify none for TLS

    # ── strip Bright Data trace headers before response reaches client ──────
    http-response del-header X-Luminati-IP
    http-response del-header X-Luminati-Timeline
    http-response del-header X-Luminati-Tun-Timeline
    http-response del-header X-Luminati-P2P-Timeline
    http-response del-header X-BRD-IP
    http-response del-header X-BRD-Timeline
    http-response del-header X-BRD-Tun-Timeline
    http-response del-header X-BRD-P2P-Timeline
