###############################################################################
# Global
###############################################################################
global
    log stdout format raw local0
    nbthread 2               # use a concrete value
    maxconn 200000

###############################################################################
# Defaults
###############################################################################
defaults
    mode tcp
    timeout client  4m
    timeout server  4m
    option  dontlognull

###############################################################################
# Demo user (replace or manage via Runtime API)
###############################################################################
userlist customers
    user demo insecure-password password

###############################################################################
# Front-end :443 (HTTPS / CONNECT) and :1080 (SOCKS5 via 3proxy)
###############################################################################
frontend edge_in
    bind :443
    bind :1080
    mode tcp

    # Basic auth for HTTP CONNECT
    tcp-request inspect-delay 5s
    acl good_auth http_auth(customers)
    http-request auth realm FlashProxy if !good_auth

    # Per-IP bandwidth cap (1 Gbps ≈ 125 MB/s)
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request content track-sc0 src
    acl over_quota  sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    default_backend superproxy

###############################################################################
# Back-end – Bright Data super-proxy
###############################################################################
backend superproxy
    mode tcp
    # Bright Data accepts creds in the TCP connect string
    server brd1 \
      brd-customer-hl_19cb0fe8-zone-al4-country-US-session-12345678:035knx33dmn2@brd.superproxy.io:22225
