###############################################################################
# FlashProxy – Edge Gateway (HAProxy 2.9)          (SPOE removed)
#   • Upstream auth handled by flash-auth-proxy (:443 → 127.0.0.1:8443)
#   • Per-IP 1 Gb/s bandwidth guard (optional; keep or delete)
#   • Bright Data super-proxy backend
###############################################################################

############################### GLOBAL ########################################
global
    log stdout format raw local0
    master-worker                 # seamless reloads
    nbthread 2
    maxconn 200000

############################### DEFAULTS ######################################
defaults
    mode            http
    timeout connect 5s
    timeout client  4m
    timeout server  4m
    option          dontlognull

############################### FRONTEND ######################################
frontend edge_in
    bind 127.0.0.1:8443            # traffic arrives from auth-proxy only
    mode http

    # ── per-IP bandwidth cap (1 Gb/s) ───────────────────────────────────────
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request  session track-sc0 src
    acl           over_quota sc0_bytes_out_rate gt 125000000   # 1 Gb/s
    tcp-request   content reject if over_quota

    # (all auth logic is upstream now)

    # ── inject Bright Data credentials ─────────────────────────────────────
    http-request set-header Proxy-Authorization \
        "Basic YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI="

    default_backend superproxy

############################### BACKEND #######################################
backend superproxy
    mode http
    # to use TLS upstream: server brd1 brd.superproxy.io:443 ssl verify none
    server brd1 brd.superproxy.io:22225

    # ── strip BD trace headers before client sees them ──────────────────────
    http-response del-header X-Luminati-IP
    http-response del-header X-Luminati-Timeline
    http-response del-header X-Luminati-Tun-Timeline
    http-response del-header X-Luminati-P2P-Timeline
    http-response del-header X-BRD-IP
    http-response del-header X-BRD-Timeline
    http-response del-header X-BRD-Tun-Timeline
    http-response del-header X-BRD-P2P-Timeline
