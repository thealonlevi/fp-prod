###############################################################################
# Global section
###############################################################################
global
    log stdout format raw local0
    maxconn 200000                  # removed ‘nbthread auto’ (use nbthread <n> if needed)

###############################################################################
# Default settings
###############################################################################
defaults
    mode tcp
    timeout client  4m
    timeout server  4m
    option  dontlognull

###############################################################################
# Demo user database (replace later or manage via Runtime API)
###############################################################################
userlist customers
    user demo insecure-password password

###############################################################################
# Front-end – accepts HTTPS / HTTP-CONNECT on :443 and SOCKS5 on :1080
###############################################################################
frontend edge_in
    bind :443
    bind :1080
    mode tcp

    # Basic auth for CONNECT requests
    tcp-request inspect-delay 5s
    acl good_auth http_auth(customers)
    http-request auth realm FlashProxy if !good_auth

    # Stick table for per-IP bandwidth cap (1 Gbps ≈ 125 MB/s)
    stick-table type ip size 1m expire 1s store bytes_out_rate(1s)
    tcp-request content track-sc0 src
    acl over_quota  sc0_bytes_out_rate gt 125000000
    tcp-request content reject if over_quota

    default_backend superproxy

###############################################################################
# Back-end – Bright Data super-proxy
###############################################################################
backend superproxy
    mode tcp
    # Add Proxy-Authorization header with base64-encoded "user:pass"
    http-request set-header Proxy-Authorization \
      "Basic YnJkLWN1c3RvbWVyLWhsXzE5Y2IwZmU4LXpvbmUtYWw0LWNvdW50cnktVVMtc2Vzc2lvbi0xMjM0NTY3ODowMzVrbngzM2RtbjI="
    server brd1 brd.superproxy.io:22225
