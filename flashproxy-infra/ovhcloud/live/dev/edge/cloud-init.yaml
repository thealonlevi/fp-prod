#cloud-config
package_update: true
packages: [docker.io, curl, tar]

write_files:
  ########################################################
  # Promtail config â€” scraped by dockerâ€‘compose service
  ########################################################
  - path: /opt/src/promtail.yaml
    permissions: '0644'
    content: |
      server:
        http_listen_port: 0
      positions:
        filename: /var/log/positions.yaml
      clients:
        - url: http://localhost:3100/loki/api/v1/push
      scrape_configs:
        - job_name: flash-edge
          static_configs:
            - targets: ['localhost']
              labels:
                job: flash-edge
                __path__: /var/log/*proxy*.log

runcmd:
  - systemctl enable --now docker

  # â”€â”€â”€ Fetch and extract fpâ€‘prod release v0.11 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - mkdir -p /opt/src
  - curl -L https://github.com/thealonlevi/fp-prod/archive/refs/tags/0.11.tar.gz -o /opt/src/fp-prod-0.11.tar.gz
  - tar -xzf /opt/src/fp-prod-0.11.tar.gz --strip-components=1 -C /opt/src

  # â”€â”€â”€ Start the edge stack (HAProxy, 3proxy, Loki, Grafana, Promtail) â”€â”€â”€
  - docker compose -f /opt/src/flashproxy-infra/flash-gateway-mvp/docker-compose.yml up -d

final_message: "ðŸš€ FlashProxy edge ready: HAProxy & observability stack running."
